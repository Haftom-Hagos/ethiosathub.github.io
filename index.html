<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EthioSatHub - Satellite Image Processing</title>
    
    <!-- Leaflet and Leaflet Draw -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="styles.css"> <!-- Your existing CSS -->
</head>
<body>
    <h1>Welcome to EthioSatHub</h1>
    <p>Select an area on the map and download NDVI or Land Cover maps.</p>

    <!-- Map Container -->
    <div id="map" style="height: 500px; width: 100%;"></div>

    <!-- Controls -->
    <div style="margin-top: 10px;">
        <button id="ndviBtn">Download NDVI Map</button>
        <button id="landCoverBtn">Download Land Cover Map</button>
    </div>

    <!-- Scripts -->
    <script src="https://earthengine.googleapis.com/v1alpha/projects/earthengine-public/assets:lookup"></script>
    <script src="https://code.earthengine.google.com/static/eejs/v1.0.0/ee_api_js.js"></script>

    <!-- Include your custom JavaScript -->
    <script src="satellite.js"></script>
    
    <script>
        // Initialize Leaflet Map
        const map = L.map('map').setView([9.145, 40.4897], 6); // Center on Ethiopia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Variable to store user-selected area
        let selectedArea = null;

        // Add drawing capability (simple rectangle for now)
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                rectangle: true,
                polygon: false,
                circle: false,
                marker: false,
                polyline: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        map.on('draw:created', (e) => {
            drawnItems.clearLayers();
            selectedArea = e.layer;
            drawnItems.addLayer(selectedArea);
        });

        // Google Earth Engine Initialization (added authentication)
        function initializeGEE() {
            ee.Authenticate(function() {
                console.log('Authenticated successfully!');
                // Initialize after successful authentication
                ee.initialize(null, null, () => {
                    console.log("Google Earth Engine initialized!");
                }, (error) => {
                    console.error("GEE Initialization failed:", error);
                    alert('Google Earth Engine initialization failed. Check the console for details.');
                });
            }, function(error) {
                console.error('Authentication failed:', error);
                alert('Authentication failed. Please check your Google account permissions.');
            });
        }

        // Call the initialization function
        initializeGEE();

        // Function to calculate NDVI
        function calculateNDVI(geometry) {
            const sentinel2 = ee.ImageCollection('COPERNICUS/S2')
                .filterBounds(geometry)
                .filterDate('2023-01-01', '2023-12-31')
                .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
                .median();

            const ndvi = sentinel2.normalizedDifference(['B8', 'B4']).rename('NDVI');
            return ndvi.clip(geometry);
        }

        // Function to download image
        function downloadImage(image, filename) {
            image.getDownloadURL({
                name: filename,
                scale: 30, // Resolution in meters
                region: selectedArea.toGeoJSON().geometry,
                format: 'GeoTIFF'
            }, (url) => {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
            }, (error) => {
                alert('Error generating download: ' + error);
            });
        }

        // Button Event Listeners
        document.getElementById('ndviBtn').addEventListener('click', () => {
            if (!selectedArea) {
                alert('Please draw an area on the map first!');
                return;
            }
            const geometry = ee.Geometry.Rectangle(selectedArea.getBounds().toBBoxArray());
            const ndviImage = calculateNDVI(geometry);
            downloadImage(ndviImage, 'NDVI_Map');
        });

        document.getElementById('landCoverBtn').addEventListener('click', () => {
            if (!selectedArea) {
                alert('Please draw an area on the map first!');
                return;
            }
            const geometry = ee.Geometry.Rectangle(selectedArea.getBounds().toBBoxArray());
            const landCover = ee.Image('COPERNICUS/S2_LC').clip(geometry);
            downloadImage(landCover, 'LandCover_Map');
        });
    </script>
</body>
</html>
