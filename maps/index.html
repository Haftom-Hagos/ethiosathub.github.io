<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EGSH-Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <nav class="navbars">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="/home">EGSH</a>
      </div>
      <div class="hamburger" id="hamburger">☰</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="/home" class="nav-link">Home</a>
        </li>
        <li class="nav-item">
          <a href="/maps" class="nav-link active">Maps</a>
        </li>
        <li class="nav-item">
          <a href="/data" class="nav-link">Data</a>
        </li>
        <li class="nav-item">
          <a href="/gallery" class="nav-link">Gallery</a>
        </li>
        <li class="nav-item">
          <a href="/about" class="nav-link">About</a>
        </li>
      </ul>
    </div>
  </nav>
  
  <div class="sub-contents">
    <div id="maps" class="tabcontent">
      <h2>Map view</h2>
      <p>
        Select a dataset, time range, and administrative feature (or draw an area) to visualize and download. 
        For larger areas or more satellite sources, please use the Vegetation Indices app.
      </p>
      <div class="map-container">
        <div id="map"></div>
      </div>
      <div class="filters">
        <div class="labels-row">
        </div>
        <div class="selects-row">
          <select id="datasetSelect">
            <option value="">Select dataset</option>
            <option value="landcover">Land cover</option>
            <option value="sentinel2">Sentinel-2</option>
            <option value="landsat8">Landsat 8</option>
            <option value="modis">MODIS</option>
            <option value="climate">Climate</option>
          </select>
          <select id="indexSelect">
            <option value="">Select sub dataset</option>
          </select>
          <select id="adminLevel">
            <option value="">choose admin level</option>
            <option value="adm1">Level 1 (Regions)</option>
            <option value="adm2">Level 2 (Zones)</option>
            <option value="adm3" selected>Level 3 (Districts)</option>
          </select>
          <select id="featureSelect">
            <option value="">choose feature</option>
          </select>
        </div>
      </div>
      <div class="time-range">
        <div>
          <strong>From:</strong>
          <select id="fromYear"></select>
          <select id="fromMonth"></select>
          <select id="fromDay"></select>
        </div>
        <div>
          <strong>To:</strong>
          <select id="toYear"></select>
          <select id="toMonth"></select>
          <select id="toDay"></select>
        </div>
      </div>
      <div class="button-container">
        <button id="viewBtn">View Selection</button>
        <button id="downloadBtn">Download Selection</button>
      </div>
      <div id="legend"></div>
      <!--div>
        <a class="btn" href="https://ethiosathub-gee.projects.earthengine.app/view/vegind" target="_blank">
          Open Vegetation Indices App
        </a>
    </div-->
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/esri-leaflet"></script>
  <script src="https://unpkg.com/proj4@2.7.5/dist/proj4.js"></script>
  <script src="../script.js"></script>
  <script>
    // Navbar toggle
    const hamburger = document.getElementById("hamburger");
    const navmenu = document.querySelector(".nav-menu");
    hamburger.addEventListener("click", () => {
      navmenu.classList.toggle("show");
      hamburger.textContent = (hamburger.textContent === "☰") ? "✖" : "☰";
    });

    // Dynamic index selector based on dataset
    const datasetSelect = document.getElementById('datasetSelect');
    const indexSelect = document.getElementById('indexSelect');

    datasetSelect.addEventListener('change', function() {
      const selectedDataset = this.value;
      let optionsHtml = '<option value="">';

      if (selectedDataset === 'landcover') {
        optionsHtml += 'Select land cover</option><option value="dynamic">dynamic land cover (10 m)</option>';
      } else if (['sentinel2', 'landsat8', 'modis'].includes(selectedDataset)) {
        optionsHtml += 'Select vegetation indices</option><option value="ndvi">NDVI</option><option value="evi">EVI</option><option value="savi">SAVI</option><option value="msavi">MSAVI</option><option value="ndmi">NDMI</option><option value="ndwi">NDWI</option><option value="nbr">NBR</option><option value="nbr2">NBR2</option><option value="tvi">TVI</option>';
      } else if (selectedDataset === 'climate') {
        optionsHtml += 'Select drought indices</option><option value="spi">SPI</option><option value="vhi">VHI</option>';
      } else {
        optionsHtml += 'Select sub dataset</option>';
      }

      indexSelect.innerHTML = optionsHtml;
      indexSelect.value = '';
      updateYears();
    });

    // Time range dynamic population
    const startYears = {
      'landcover': 2015,
      'sentinel2': 2015,
      'landsat8': 2013,
      'modis': 2000,
      'climate': 1981
    };

    const fromYear = document.getElementById('fromYear');
    const toYear = document.getElementById('toYear');
    const fromMonth = document.getElementById('fromMonth');
    const toMonth = document.getElementById('toMonth');
    const fromDay = document.getElementById('fromDay');
    const toDay = document.getElementById('toDay');

    function populateMonths(select) {
      let html = '';
      const months = ['01 (Jan)', '02 (Feb)', '03 (Mar)', '04 (Apr)', '05 (May)', '06 (Jun)', 
                      '07 (Jul)', '08 (Aug)', '09 (Sep)', '10 (Oct)', '11 (Nov)', '12 (Dec)'];
      for (let i = 0; i < 12; i++) {
        html += `<option value="${i+1}">${months[i]}</option>`;
      }
      select.innerHTML = html;
    }

    function populateDays(select) {
      let html = '';
      for (let d = 1; d <= 31; d++) {
        html += `<option value="${d}">${d}</option>`;
      }
      select.innerHTML = html;
    }

    function updateYears() {
      const selectedDataset = datasetSelect.value;
      const start = startYears[selectedDataset] || 2025;
      const current = 2025; // As per current date

      let html = '';
      for (let y = start; y <= current; y++) {
        html += `<option value="${y}">${y}</option>`;
      }
      fromYear.innerHTML = html;
      toYear.innerHTML = html;

      // Set default if needed
      if (!fromYear.value || parseInt(fromYear.value) < start) {
        fromYear.value = current;
      }
      if (!toYear.value || parseInt(toYear.value) < start) {
        toYear.value = current;
      }
    }

    // Initialize
    populateMonths(fromMonth);
    populateMonths(toMonth);
    populateDays(fromDay);
    populateDays(toDay);
    fromMonth.value = '10';
    toMonth.value = '10';
    fromDay.value = '1';
    toDay.value = '31';
    updateYears();
  </script>
</body>
</html>
